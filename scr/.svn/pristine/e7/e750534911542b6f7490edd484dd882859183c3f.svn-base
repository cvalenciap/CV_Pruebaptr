create or replace package body PCK_ALC_REPORFITOPLANCTON is

PROCEDURE PRC_BUSCA_REPORFITODETALLE(
  --Campos Identificador registro
   PAR_FECREP         VARCHAR2,
   PAR_PUNTO         INTEGER,

   par_out_quantity     OUT INTEGER,
      --PARAMETRO OUT  
   PAR_OUT_CURSOR OUT SYS_REFCURSOR
)
IS
V_QUERY VARCHAR2(1000);

BEGIN

V_QUERY := 'SELECT N_LOCMUE, D_FECMUE, N_CLOROF, N_FICOCI FROM ALC_MUESTRFOR242 a
                        INNER JOIN ALC_FORMULHEADER b
                        ON a.N_CODHFO = b.N_CODHFO WHERE  N_LOCMUE = '|| PAR_PUNTO ||' AND TO_CHAR(D_FECMUE,''dd/MM/YYYY'') = ''' || PAR_FECREP || '''';

OPEN PAR_OUT_CURSOR FOR V_QUERY;

END;


 PROCEDURE PRC_INSERT_REPORTEFITO(
   --auditoria
    PAR_USUCRE           ALC_REPORFITO.A_USUCRE%TYPE,
	PAR_NOMPRG           ALC_REPORFITO.A_NOMPRG%TYPE,

    PAR_FECMUE           ALC_REPORFITO.D_FECMUE%TYPE,
    PAR_PERMUE           ALC_REPORFITO.N_PERMUE%TYPE,
    PAR_PERANA           ALC_REPORFITO.N_PERANA%TYPE,
    PAR_CORDET           ALC_REPORFITO.N_CORDET%TYPE,
    PAR_CODSUB           ALC_REPORFITO.N_CODSUB%TYPE,
    PAR_CANCLO           ALC_REPORFITO.N_CANCLO%TYPE,
    PAR_CANFIC           ALC_REPORFITO.N_CANFIC%TYPE
 )
 IS

 BEGIN
 INSERT INTO ALC_REPORFITO ( A_USUCRE ,A_USUMOD, A_FECMOD , A_NOMPRG , N_CODREP , D_FECREP , D_FECMUE , N_PERMUE , N_PERANA , N_CORDET ,
                              N_CODSUB , N_CANCLO , N_CANFIC)
 VALUES ( PAR_USUCRE,PAR_USUCRE, SYSDATE, PAR_NOMPRG, SQ_ALC_REPORFITO.NEXTVAL, SYSDATE ,PAR_FECMUE,PAR_PERMUE,PAR_PERANA,PAR_CORDET,
                              PAR_CODSUB, PAR_CANCLO , PAR_CANFIC );
END;

PROCEDURE PRC_CORREDET_REPORTEFITO(
   par_out_quantity     OUT INTEGER
)
IS
V_QUERY_COUNT VARCHAR2(100);
 BEGIN 
     V_QUERY_COUNT := 'SELECT  MAX(N_CORDET) FROM ALC_REPORFITO'; 
          execute immediate V_QUERY_COUNT into par_out_quantity;
END;


PROCEDURE PRC_BUSCA_REPORTEFITO(
  --Campos Identificador registro
   PAR_FECREP         VARCHAR2,
   --PARAMETROS DE LA PAGINACION
       PAR_COL_ORDER_BY     IN INTEGER,
       PAR_COL_ORDER_BY_DIR IN VARCHAR2 ,
       PAR_PAG_DESDE        IN INTEGER,
       PAR_CANTIDAD_PAG     IN INTEGER,
       --PARAMETROS DE RETORNO
       par_out_quantity     OUT INTEGER, 
      --PARAMETRO OUT  
   PAR_OUT_CURSOR OUT SYS_REFCURSOR
)
IS
V_QUERY VARCHAR2(1000);
V_QUERY_COUNT VARCHAR2(500);
V_QUERY_FROM VARCHAR2(500);
V_QUERY_FROM_COUNT VARCHAR2(500);

 BEGIN 

          V_QUERY_COUNT := 'select count(*) '; 

          V_QUERY := 'SELECT * FROM ( select e.*,rownum rn from (select N_CORDET ,D_FECREP, D_FECMUE , N_PERMUE , N_PERANA from (select a.*
                        from (SELECT c.N_CORDET, c.D_FECREP, c.D_FECMUE, c.N_PERMUE, c.N_PERANA ';

          V_QUERY_FROM := ' FROM ALC_REPORFITO c WHERE TO_CHAR(D_FECREP,''dd/mm/YYYY'') = ''' ||PAR_FECREP|| '''';

          V_QUERY_FROM_COUNT := ' FROM ( SELECT N_CORDET FROM ALC_REPORFITO c WHERE TO_CHAR(D_FECREP,''dd/mm/YYYY'') = ''' ||PAR_FECREP|| ''' GROUP BY N_CORDET ) ' ;

          V_QUERY := V_QUERY || V_QUERY_FROM;

          V_QUERY_COUNT := V_QUERY_COUNT || V_QUERY_FROM_COUNT;

          V_QUERY := V_QUERY || ' order by '|| PAR_COL_ORDER_BY || ' ' || PAR_COL_ORDER_BY_DIR || ' ) a ) GROUP BY N_CORDET,D_FECREP,D_FECMUE,N_PERMUE,N_PERANA) e ) where rn > ' || PAR_PAG_DESDE || ' and rn <= ' || (PAR_PAG_DESDE+PAR_CANTIDAD_PAG);

          OPEN PAR_OUT_CURSOR FOR V_QUERY;

          execute immediate V_QUERY_COUNT into par_out_quantity;

END;


PROCEDURE PRC_BUSCA_DETXCORRELFITO(
   PAR_CORDET        ALC_REPORHIDRO.N_CORDET%TYPE,
   PAR_OUT_CURSOR OUT SYS_REFCURSOR
)
IS
V_QUERY VARCHAR2(200);
 BEGIN 
     V_QUERY := 'SELECT  D_FECREP,D_FECMUE,N_PERMUE,N_PERANA, N_CORDET,N_CODSUB,N_CANCLO,N_CANFIC FROM ALC_REPORFITO WHERE N_CORDET = ' || PAR_CORDET; 
     OPEN PAR_OUT_CURSOR FOR V_QUERY;
END;

PROCEDURE PRC_DELETE_REPORTEFITO(
   PAR_CORDET        ALC_REPORFITO.N_CORDET%TYPE
)
 IS
 BEGIN
    DELETE FROM ALC_REPORFITO WHERE N_CORDET = PAR_CORDET;
END;

end PCK_ALC_REPORFITOPLANCTON;