create or replace package body PCK_ALC_ENSAYOCLORO is

  PROCEDURE PRC_BUSCA_ENSAYOCLORO( 

       --PARAMETROS DE LA PAGINACION
       PAR_FECMUE     IN VARCHAR2,
       PAR_COL_ORDER_BY     IN INTEGER,
       PAR_COL_ORDER_BY_DIR IN VARCHAR2 ,
       PAR_PAG_DESDE        IN INTEGER,
       PAR_CANTIDAD_PAG     IN INTEGER,
       --PARAMETROS DE RETORNO
       PAR_OUT_QUANTITY     OUT INTEGER,
       PAR_OUT_CURSOR       OUT SYS_REFCURSOR
       
    ) IS 
    V_QUERY VARCHAR2(4000);
    V_QUERY_FROM VARCHAR2(4000);
    V_QUERY_COUNT VARCHAR2(4000);	

    BEGIN
        IF (PAR_FECMUE = '' ) OR (PAR_FECMUE IS NULL) THEN
           V_QUERY_FROM := ' from ALC_ENSAYOCLORO c WHERE c.N_STATUS = 1 ';
        ELSE 
           V_QUERY_FROM := ' from ALC_ENSAYOCLORO c WHERE c.N_STATUS = 1 AND TO_CHAR(c.D_FECMUE,''dd/mm/YYYY'') = ''' || PAR_FECMUE || '''';

        END IF;

          V_QUERY_COUNT := 'select count(*) '; 
          V_QUERY := 'select * 
                      from (select a.*, rownum rn
                            from (select  c.D_FECMUE,c.C_HORMUE,c.C_PLAMUE,c.C_METMUE, c.N_PERANA,c.N_CODIGO ';

          V_QUERY := V_QUERY || V_QUERY_FROM;

          V_QUERY_COUNT := V_QUERY_COUNT || V_QUERY_FROM;

          V_QUERY := V_QUERY || ' order by '|| PAR_COL_ORDER_BY || ' ' || PAR_COL_ORDER_BY_DIR || ' ) a ) where rn > ' || PAR_PAG_DESDE || ' and rn <= ' || (PAR_PAG_DESDE+PAR_CANTIDAD_PAG);

          OPEN par_out_cursor FOR v_query;
          execute immediate v_query_count into par_out_quantity;

END;


PROCEDURE PRC_BUSCA_ENSAYOCLOROXID( 

      --PARAMETROS
      PAR_CODIGO IN ALC_ENSAYOCLORO.N_CODIGO%TYPE,     
      PAR_OUT_CURSOR       OUT SYS_REFCURSOR

    ) IS 
    V_QUERY VARCHAR2(4000);

    BEGIN
    V_QUERY := 'SELECT a.N_CODIGO, TO_CHAR(a.D_FECMUE,''dd/mm/YYYY'') , a.C_HORMUE, a.C_PLAMUE, TO_CHAR(a.D_FECREP,''dd/mm/YYYY'') ,TO_CHAR(a.D_FEINEN,''dd/mm/YYYY'') , a.C_HEINEN, a.C_METMUE,'||
               'a.N_VOLMUE, a.C_TCONTA, a.N_PERANA, a.C_TURNO, a.N_STATUS, TO_CHAR(a.D_FRECEP,''dd/mm/YYYY'') , a.C_HRECEP, a.N_PRECEP,  ' || 
               ' C_SODIO1,C_SODIO2,C_SODIO3,C_SODIO4, C_CLORO1,C_CLORO2,C_CLORO3,C_CLORO4,N_BICRO1,N_BICRO2,N_BICRO3,N_SOLUC1,N_SOLUC2,N_SOLUC3,C_OBSERV ' ||
               'FROM ALC_ENSAYOCLORO a WHERE N_CODIGO = ' || PAR_CODIGO;

    OPEN PAR_OUT_CURSOR FOR V_QUERY;
END;

PROCEDURE PRC_BUSCA_ENSAYOCLORODETA( 

      --PARAMETROS
      PAR_CODIGO IN ALC_ENSACLORODET.N_CODIGO%TYPE,     
      PAR_OUT_CURSOR       OUT SYS_REFCURSOR

    ) IS 
    V_QUERY VARCHAR2(4000);

    BEGIN
    V_QUERY := 'SELECT b.N_CODETA , b.N_PUNMUE, b.N_PH, b.N_TEMPER, b.N_NUMFRA, b.N_VOLUME, b.N_DOSIS,' ||  
               'b.N_CLLIBR, b.N_CLCOMB, b.N_CLTOTA, b.N_CLORLI, b.N_CLORTO, b.N_CLORDE, b.N_TIPDET ,b.N_STATUS,b.N_SELECT ' || 
               'FROM ALC_ENSACLORODET b WHERE N_CODIGO = ' || PAR_CODIGO;

    OPEN PAR_OUT_CURSOR FOR V_QUERY;
END;


PROCEDURE PRC_INSERT_ENSAYOCLORO(

   --auditoria
	PAR_USUCRE           ALC_ENSAYOCLORO.A_USUCRE%TYPE,
	PAR_NOMPRG           ALC_ENSAYOCLORO.A_NOMPRG%TYPE,

   --parametros
    PAR_CODIGO	ALC_ENSAYOCLORO.N_CODIGO%TYPE,
	PAR_FECMUE	ALC_ENSAYOCLORO.D_FECMUE%TYPE,
    PAR_HORMUE	ALC_ENSAYOCLORO.C_HORMUE%TYPE,
    PAR_PLAMUE	ALC_ENSAYOCLORO.C_PLAMUE%TYPE,
    PAR_FECREP	ALC_ENSAYOCLORO.D_FECREP%TYPE,
    PAR_FEINEN	ALC_ENSAYOCLORO.D_FEINEN%TYPE,
    PAR_HEINEN	ALC_ENSAYOCLORO.C_HEINEN%TYPE,
    PAR_METMUE	ALC_ENSAYOCLORO.C_METMUE%TYPE,
    PAR_VOLMUE	ALC_ENSAYOCLORO.N_VOLMUE%TYPE,
    PAR_TCONTA	ALC_ENSAYOCLORO.C_TCONTA%TYPE,
    PAR_PERANA	ALC_ENSAYOCLORO.N_PERANA%TYPE,
    PAR_TURNO	ALC_ENSAYOCLORO.C_TURNO%TYPE,
    PAR_STATUS	ALC_ENSAYOCLORO.N_STATUS%TYPE,
    PAR_FRECEP	ALC_ENSAYOCLORO.D_FRECEP%TYPE,
    PAR_HRECEP	ALC_ENSAYOCLORO.C_HRECEP%TYPE,
    PAR_PRECEP  ALC_ENSAYOCLORO.N_PRECEP%TYPE,

    PAR_SODIO1  ALC_ENSAYOCLORO.C_SODIO1%TYPE,
    PAR_SODIO2  ALC_ENSAYOCLORO.C_SODIO2%TYPE,
    PAR_SODIO3  ALC_ENSAYOCLORO.C_SODIO3%TYPE,
    PAR_SODIO4  ALC_ENSAYOCLORO.C_SODIO4%TYPE,
    PAR_CLORO1  ALC_ENSAYOCLORO.C_SODIO1%TYPE,
    PAR_CLORO2  ALC_ENSAYOCLORO.C_SODIO2%TYPE,
    PAR_CLORO3  ALC_ENSAYOCLORO.C_SODIO3%TYPE,
    PAR_CLORO4  ALC_ENSAYOCLORO.C_SODIO4%TYPE,
    
    PAR_BICRO1  ALC_ENSAYOCLORO.N_BICRO1%TYPE,
    PAR_BICRO2  ALC_ENSAYOCLORO.N_BICRO2%TYPE,
    PAR_BICRO3  ALC_ENSAYOCLORO.N_BICRO3%TYPE,
    
    PAR_SOLUC1  ALC_ENSAYOCLORO.N_SOLUC1%TYPE,
    PAR_SOLUC2  ALC_ENSAYOCLORO.N_SOLUC2%TYPE,
    PAR_SOLUC3  ALC_ENSAYOCLORO.N_SOLUC3%TYPE,
    
    PAR_OBSERV  ALC_ENSAYOCLORO.C_OBSERV%TYPE,
    
    PAR_OUT_RETURN        OUT INTEGER
)
 IS
 v_exists varchar2(1) := 'F';
 v_id INTEGER(10):=-1;
 PROGRAM_NAME VARCHAR2(60) := 'PCK_ALC_ENSAYOCLORO.PRC_INSERT_ENSAYOCLORO';
 BEGIN
    begin
    SELECT 'T'  
    into v_exists
    FROM ALC_ENSAYOCLORO
    WHERE N_CODIGO = PAR_CODIGO ;
    exception
    when no_data_found then
      null;
 END;


 IF( v_exists = 'T' )
 THEN
 UPDATE ALC_ENSAYOCLORO
  SET 
    D_FECMUE =PAR_FECMUE,
	C_HORMUE =PAR_HORMUE,
	C_PLAMUE =PAR_PLAMUE,
	D_FECREP =PAR_FECREP,
	D_FEINEN =PAR_FEINEN,
	C_HEINEN =PAR_HEINEN,
	C_METMUE =PAR_METMUE,
	N_VOLMUE =PAR_VOLMUE,
	C_TCONTA =PAR_TCONTA,
	N_PERANA =PAR_PERANA,
	C_TURNO  =PAR_TURNO,
	N_STATUS =PAR_STATUS,
	D_FRECEP =PAR_FRECEP,
	C_HRECEP =PAR_HRECEP,
    N_PRECEP =PAR_PRECEP,

    
    C_SODIO2 = PAR_SODIO2,
    C_SODIO3 = PAR_SODIO3,
    C_SODIO4 = PAR_SODIO4,
    
    C_CLORO2 = PAR_CLORO2,
    C_CLORO3 = PAR_CLORO3,
    C_CLORO4 = PAR_CLORO4,
    
    N_BICRO1 = PAR_BICRO1,
    N_BICRO2 = PAR_BICRO2,
    N_BICRO3 = PAR_BICRO3,
    N_SOLUC1 = PAR_SOLUC1,
    N_SOLUC2 = PAR_SOLUC2,
    N_SOLUC3 = PAR_SOLUC3,
    C_OBSERV = PAR_OBSERV

  WHERE N_CODIGO = PAR_CODIGO;
  PAR_OUT_RETURN := PAR_CODIGO;

 ELSE
 -- v_id := SQ_ALC_ENSAYOCLORO.NEXTVAL;
  INSERT INTO ALC_ENSAYOCLORO ( A_USUCRE,A_USUMOD, A_FECMOD, A_FECCRE , A_NOMPRG, 
                                N_CODIGO, D_FECMUE , C_HORMUE, C_PLAMUE, D_FECREP, D_FEINEN, C_HEINEN, C_METMUE, 
                                N_VOLMUE, C_TCONTA, N_PERANA, C_TURNO , N_STATUS, D_FRECEP, C_HRECEP,N_PRECEP,
                                C_SODIO2,C_SODIO3,C_SODIO4,C_CLORO2,C_CLORO3,C_CLORO4,
                                N_BICRO1,N_BICRO2,N_BICRO3,N_SOLUC1,N_SOLUC2,N_SOLUC3,C_OBSERV)

  VALUES ( PAR_USUCRE,PAR_USUCRE,SYSDATE,SYSDATE,PROGRAM_NAME,
          SQ_ALC_ENSAYOCLORO.NEXTVAL, PAR_FECMUE, PAR_HORMUE, PAR_PLAMUE, PAR_FECREP, PAR_FEINEN, PAR_HEINEN, PAR_METMUE, 
          PAR_VOLMUE,PAR_TCONTA,PAR_PERANA, PAR_TURNO , PAR_STATUS, PAR_FRECEP, PAR_HRECEP, PAR_PRECEP,
          PAR_SODIO2,PAR_SODIO3,PAR_SODIO4,PAR_CLORO2,PAR_CLORO3,PAR_CLORO4,
          PAR_BICRO1,PAR_BICRO2,PAR_BICRO3,PAR_SOLUC1,PAR_SOLUC2,PAR_SOLUC3,PAR_OBSERV);

    PAR_OUT_RETURN := SQ_ALC_ENSAYOCLORO.CURRVAL;
 END IF;
END;


PROCEDURE PRC_INSERT_ENSAYOCLORODET(

   --auditoria
	PAR_USUCRE           ALC_ENSAYOCLORO.A_USUCRE%TYPE,
	PAR_NOMPRG           ALC_ENSAYOCLORO.A_NOMPRG%TYPE,


--parametros
    PAR_CODIGO	    ALC_ENSACLORODET.N_CODIGO%TYPE,
    PAR_CODETA	    ALC_ENSACLORODET.N_CODETA%TYPE,
	PAR_PUNMUE		ALC_ENSACLORODET.N_PUNMUE%TYPE,
	PAR_PH			ALC_ENSACLORODET.N_PH%TYPE,
	PAR_TEMPER		ALC_ENSACLORODET.N_TEMPER%TYPE,
	PAR_NUMFRA		ALC_ENSACLORODET.N_NUMFRA%TYPE,
	PAR_VOLUME		ALC_ENSACLORODET.N_VOLUME%TYPE,
	PAR_DOSIS		ALC_ENSACLORODET.N_DOSIS%TYPE,
	PAR_CLLIBR		ALC_ENSACLORODET.N_CLLIBR%TYPE,
	PAR_CLCOMB		ALC_ENSACLORODET.N_CLCOMB%TYPE,
	PAR_CLTOTA		ALC_ENSACLORODET.N_CLTOTA%TYPE,
	PAR_CLORLI		ALC_ENSACLORODET.N_CLORLI%TYPE,
	PAR_CLORTO		ALC_ENSACLORODET.N_CLORTO%TYPE,
	PAR_CLORDE		ALC_ENSACLORODET.N_CLORDE%TYPE,
	PAR_TIPDET		ALC_ENSACLORODET.N_TIPDET%TYPE,
	PAR_STATUS		ALC_ENSACLORODET.N_STATUS%TYPE,
    PAR_SELECT		ALC_ENSACLORODET.N_SELECT%TYPE
)
 IS

 v_exists varchar2(1) := 'F';
 PROGRAM_NAME VARCHAR2(60) := 'PCK_ALC_ENSAYOCLORO.PRC_INSERT_ENSAYOCLORODET';
 BEGIN
    begin
    SELECT 'T'  
    into v_exists
    FROM ALC_ENSACLORODET
    WHERE N_CODETA = PAR_CODETA ;
    exception
    when no_data_found then
      null;
 END;


 IF( v_exists = 'T' )
 THEN

 UPDATE ALC_ENSACLORODET
  SET 
    A_USUCRE=PAR_USUCRE,

    N_CODIGO = PAR_CODIGO,
	N_PUNMUE=PAR_PUNMUE,
	N_PH	=PAR_PH,
	N_TEMPER=PAR_TEMPER,
	N_NUMFRA=PAR_NUMFRA,
	N_VOLUME=PAR_VOLUME,
	N_DOSIS	=PAR_DOSIS,
	N_CLLIBR=PAR_CLLIBR,
	N_CLCOMB=PAR_CLCOMB,
	N_CLTOTA=PAR_CLTOTA,
	N_CLORLI=PAR_CLORLI,
	N_CLORTO=PAR_CLORTO,
	N_CLORDE=PAR_CLORDE,
	N_TIPDET=NVL(PAR_TIPDET, 0),
	N_STATUS=PAR_STATUS,
    N_SELECT=PAR_SELECT

  WHERE N_CODETA = PAR_CODETA;

 ELSE
  INSERT INTO ALC_ENSACLORODET ( A_USUCRE,A_USUMOD, A_FECMOD, A_FECCRE , A_NOMPRG, 
                                N_CODIGO, N_CODETA , N_PUNMUE, N_PH,  N_TEMPER,   N_NUMFRA, N_VOLUME, N_DOSIS,   
                                N_CLLIBR , N_CLCOMB , N_CLTOTA, N_CLORLI, N_CLORTO,N_CLORDE ,N_TIPDET,  N_STATUS,N_SELECT )
  VALUES (PAR_USUCRE,PAR_USUCRE,SYSDATE,SYSDATE,PROGRAM_NAME,
          PAR_CODIGO, SQ_ALC_ENSACLORODET.NEXTVAL, PAR_PUNMUE, PAR_PH, PAR_TEMPER , PAR_NUMFRA, PAR_VOLUME ,PAR_DOSIS,
          PAR_CLLIBR,PAR_CLCOMB,PAR_CLTOTA,PAR_CLORLI,PAR_CLORTO,PAR_CLORDE,NVL(PAR_TIPDET, 0),PAR_STATUS,PAR_SELECT);
 END IF;

END;


PROCEDURE PRC_BUSCA_ENSAYOCLOROXFECHA( 

      --PARAMETROS
      PAR_FECMUE IN VARCHAR2,
      PAR_HORMUE IN VARCHAR2, 
      PAR_OUT_CURSOR       OUT SYS_REFCURSOR

    ) IS 
    V_QUERY VARCHAR2(4000);

    BEGIN
    V_QUERY := 'SELECT a.N_CODIGO, TO_CHAR(a.D_FECMUE,''dd/mm/YYYY'') , a.C_HORMUE, a.C_PLAMUE, TO_CHAR(a.D_FECREP,''dd/mm/YYYY'') ,TO_CHAR(a.D_FEINEN,''dd/mm/YYYY'') , a.C_HEINEN, a.C_METMUE,'||
               'a.N_VOLMUE, a.C_TCONTA, a.N_PERANA, a.C_TURNO, a.N_STATUS, TO_CHAR(a.D_FRECEP,''dd/mm/YYYY'') , a.C_HRECEP, a.N_PRECEP,  ' || 
               ' C_SODIO1,C_SODIO2,C_SODIO3,C_SODIO4, C_CLORO1,C_CLORO2,C_CLORO3,C_CLORO4,C_OBSERV ' ||
               'FROM ALC_ENSAYOCLORO a WHERE  a.C_HORMUE = ''' || PAR_HORMUE || ''' AND TO_CHAR(a.D_FECMUE,''dd/mm/YYYY'') = ''' || PAR_FECMUE || '''';

    OPEN PAR_OUT_CURSOR FOR V_QUERY;
END;



PROCEDURE PRC_INACTIVAR_ENSAYOCLORO(

   --auditoria
	PAR_USUMOD           ALC_ENSAYOCLORO.A_USUMOD%TYPE,
	PAR_NOMPRG           ALC_ENSAYOCLORO.A_NOMPRG%TYPE,
   --parametros
    PAR_CODIGO           ALC_ENSAYOCLORO.N_CODIGO%TYPE

)
 IS
 BEGIN

  UPDATE ALC_ENSAYOCLORO
  SET 
    A_USUMOD = PAR_USUMOD,
	A_NOMPRG = PAR_NOMPRG,
    N_STATUS = 0
  WHERE N_CODIGO = PAR_CODIGO;

END;

PROCEDURE PRC_BUSCA_REPORTENSAYO( 

      --PARAMETROS
      PAR_PUNMUE IN ALC_ENSACLORODET.N_PUNMUE%TYPE,    
      PAR_FECMUE IN VARCHAR2,

      PAR_OUT_CURSOR       OUT SYS_REFCURSOR

    ) IS 
    V_QUERY VARCHAR2(4000);

    BEGIN
    V_QUERY := 'SELECT N_PUNMUE,N_TEMPER,N_PH,N_DOSIS,N_CLORLI,N_CLORTO,N_CLORDE , D_FECMUE, C_HORMUE, C_PLAMUE,C_METMUE,N_PERANA,N_PRECEP  FROM ALC_ENSACLORODET a ' ||  
               'INNER JOIN ALC_ENSAYOCLORO b ' ||
               'ON a.N_CODIGO = b.N_CODIGO ' ||
               'WHERE N_SELECT = 1 AND N_PUNMUE = ''' || PAR_PUNMUE || ''' AND TO_CHAR(D_FECMUE,''dd/mm/YYYY'') = ''' || PAR_FECMUE || '''';

    OPEN PAR_OUT_CURSOR FOR V_QUERY;
END;

end PCK_ALC_ENSAYOCLORO;